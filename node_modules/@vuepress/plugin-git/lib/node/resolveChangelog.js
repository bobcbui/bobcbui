import { getContributorInfo, getUserNameWithNoreplyEmail, } from './utils/index.js';
const RE_CLEAN_REFS = /[()]/g;
const parseTagName = (refs) => {
    if (!refs)
        return;
    const tags = refs
        .replace(RE_CLEAN_REFS, '')
        .split(',')
        .map((tag) => tag.trim());
    return tags[0]?.includes('tag:') ? tags[0].replace('tag:', '').trim() : '';
};
export const resolveChangelog = (app, commits, options, contributors) => {
    const result = [];
    const sliceCommits = options.maxCount
        ? commits.slice(0, options.maxCount)
        : commits;
    for (const commit of sliceCommits) {
        const { hash, message, time, author, email, refs, coAuthors } = commit;
        const tag = parseTagName(refs);
        const contributor = getContributorInfo(getUserNameWithNoreplyEmail(email) ?? author, contributors);
        const resolved = {
            hash,
            time,
            email,
            author: contributor?.name ?? contributor?.username ?? author,
            message: app.markdown.renderInline(message),
        };
        if (coAuthors.length)
            resolved.coAuthors = coAuthors;
        if (tag)
            resolved.tag = tag;
        result.push(resolved);
    }
    return result;
};
